# Feature Idea: AUSA Member CSV Export
**Date:** 2026-02-25
**Status:** Implemented
**Requested by:** AUSA (via committee)

---

## Problem Statement
AUSA requires a monthly CSV of current AUES members to process club membership transfers. We need a way to export this data reliably, avoid accidentally handing the same data twice, and prevent accidental button presses from producing inaccurate counts.

---

## Feature Description
A button on the members page that exports all current members to a CSV file formatted to AUSA's requirements. Each export is logged to the database, and the export history is visible before confirming the download — so you can see at a glance whether you've already sent this month's data.

**CSV format:**
```
Full Name,Student ID,Do you agree to abide by the Clubs Code of Conduct?,Do you consent to the transfer of your membership to the AUSA page?
John Smith,MBR-00123,TRUE,TRUE
Jane Doe,MBR-00456,TRUE,TRUE
```

- `Full Name` — the `fullname` field as-is (single column, not split)
- `Student ID` — the `membershipId` field from the database
- The two consent columns are always `TRUE` (auto-filled as per AUSA requirement; not stored in our DB)

---

## Codebase Context
- **Architecture fit:** Next.js App Router, server actions pattern. No new API routes needed. Follows existing patterns in `app/members/actions.ts` and `app/admin/actions.ts`.
- **Key existing files:**
  - `app/db/schema.ts` — DB schema (Drizzle ORM, Neon PostgreSQL)
  - `app/members/data-table.tsx` — Members table UI with toolbar (Sync button lives here)
  - `app/members/actions.ts` — Server actions for members page
  - `app/admin/actions.ts` — `getAllMembersAction` pattern to follow
  - `app/lib/activity.ts` — `ActivityLogger` convenience methods + `logActivity`
- **Relevant patterns:**
  - Server action returns data → client triggers browser download (no streaming API route needed)
  - `AlertDialog` from shadcn/ui used for confirmation dialogs (already in `data-table.tsx`)
  - Button loading states: `disabled={isLoading}` + spinner icon, matching the Sync button pattern
  - Toast notifications via `sonner`: `toast.success()` / `toast.error()`
  - Auth check pattern: `const session = await auth()` → reject if `Temporary` role or no session

---

## Chosen Approach
**Server action + DB export log table (Approach B)**

The server action fetches all members, logs the export to a new `ausaExports` DB table, and returns the CSV content as a string. The client builds a downloadable blob and triggers the browser download. Before the download begins, a confirmation dialog shows the member count and recent export history, so users can verify they're not sending duplicate data.

### Why this approach
- Fits the server action pattern used throughout the app
- Export history is persisted in the DB and visible to all dashboard users (not tied to a single browser)
- The confirmation dialog + visible history directly addresses the "accidental press / inaccurate numbers" concern
- No new libraries needed — CSV generation is straightforward string building for this simple schema
- Minimal DB change: one new table with four columns

### Files to change

- `app/db/schema.ts` — Add `ausaExports` table; add `"MEMBER_EXPORTED"` to `ActivityActionType` union
- `app/lib/activity.ts` — Add `membersExported` convenience method to `ActivityLogger`
- `app/members/actions.ts` — Add `exportMembersToCSV()` and `getAusaExportHistory()` server actions
- `app/members/data-table.tsx` — Add Export button, confirmation dialog, and recent export history display

### New files to create

- A new Drizzle migration file will be auto-generated by running `drizzle-kit generate` after schema changes. No manual file creation needed.

### New `ausaExports` table schema

```typescript
export const ausaExports = pgTable("ausa_exports", {
  id: serial("id").primaryKey(),
  exportedAt: timestamp("exported_at", { withTimezone: true, mode: "date" }).defaultNow().notNull(),
  memberCount: integer("member_count").notNull(),
  exportedByUserId: uuid("exported_by_user_id").references(() => users.id, { onDelete: "set null" }),
  exportedByUserName: text("exported_by_user_name"), // stored in case user is deleted, same pattern as activityLog
});
```

### `exportMembersToCSV()` server action (pseudocode outline)

```
1. Auth check — reject if no session or Temporary role
2. Fetch all members from DB (reuse db.select().from(members) pattern)
3. Build CSV string:
   - Header row: "Full Name,Student ID,Do you agree to abide by the Clubs Code of Conduct?,Do you consent to the transfer of your membership to the AUSA page?"
   - One row per member: escape any commas/quotes in fullname or membershipId
   - Consent columns: always "TRUE"
4. Insert row into ausaExports: { memberCount, exportedByUserId, exportedByUserName }
5. Log to activityLog via ActivityLogger.membersExported(...)
6. Return { success: true, csv: <string>, memberCount: <number> }
```

### `getAusaExportHistory()` server action (pseudocode outline)

```
1. Auth check — same as above
2. Select last 5 rows from ausaExports ORDER BY exportedAt DESC
3. Return array of { id, exportedAt, memberCount, exportedByUserName }
```

### UI changes in `data-table.tsx` (pseudocode outline)

```
State additions:
  - isExporting: boolean
  - showExportConfirm: boolean
  - exportHistory: ExportRecord[] (fetched on mount alongside member data)

Toolbar addition (after Sync button):
  <Button variant="outline" size="sm" onClick={() => setShowExportConfirm(true)} disabled={isExporting}>
    <Download icon /> Export for AUSA
  </Button>

Confirmation dialog (reuse AlertDialog already imported):
  Title: "Export members for AUSA?"
  Body:
    - "This will export [N] members to a CSV file."
    - If exportHistory[0] exists:
        Warning: "Last exported [date] by [name] ([count] members)."
    - List last 3 exports (date, who, count) so history is visible
  Footer: [Cancel] [Download CSV] (Download triggers handleExport)

handleExport():
  1. setIsExporting(true)
  2. Call exportMembersToCSV() server action
  3. On success: build Blob from csv string, create object URL, click hidden <a> to trigger download
     - Filename: "ausa-members-YYYY-MM-DD.csv"
  4. toast.success(`Exported ${memberCount} members`)
  5. Refresh exportHistory (re-fetch)
  6. setIsExporting(false), setShowExportConfirm(false)
  7. On error: toast.error(...)
```

### CSV escaping note
For the simple `fullname` and `membershipId` fields, wrap any value containing a comma or double-quote in double-quotes, and escape internal double-quotes by doubling them (`"` → `""`). No library needed for this.

### Edge cases to handle
- Member with `null` membershipId — export as empty string in the Student ID column
- Member with a comma or quote in their `fullname` — apply CSV escaping
- Zero members in the DB — the action should still succeed but export only the header row; show a warning in the confirmation dialog ("No members to export")
- Session expiry mid-action — server action returns `{ success: false, error: "Unauthorized" }`, toast the error
- `exportHistory` fetch failing — silently degrade; just don't show the history section rather than blocking the export

---

## Alternatives Considered

### Option A — Client-side export, localStorage history
CSV generation and download entirely on the client. Export history stored in Zustand and persisted to `localStorage`.

Rejected because: history is per-browser and per-user. Two committee members can't see each other's exports. History is lost if localStorage is cleared.

### Option C — Streaming API route
`GET /api/members/export` endpoint returning `Content-Disposition: attachment` with streamed CSV.

Rejected because: diverges from the server action pattern used everywhere else in the app. Auth handling is more complex on API routes. No meaningful UX benefit over Approach B for this use case.

---

## Open Questions
- [ ] Should the export be restricted to Admin-only, or is the current member auth check (exclude Temporary) sufficient?
- [ ] Should we add a "label" or "note" field to each export (e.g., "February handoff") for clearer history? Could be added to the `ausaExports` table without much extra work.

---

## Notes
- `membershipId` is being treated as the "Student ID" for AUSA's purposes, as confirmed with the team.
- The two consent columns (`Clubs Code of Conduct` and `transfer to AUSA`) are not stored in the database — they are always `TRUE` per AUSA's form requirements and are injected at export time only.
- No new npm packages are required. CSV generation can be done with plain string manipulation for the small set of fields involved.
- Migration: after editing `schema.ts`, run `npx drizzle-kit generate` then `npx drizzle-kit migrate` (or `push` depending on the environment workflow).

---

## Implementation Notes
**Implemented:** 2026-02-25
**Files changed:**
- `app/db/schema.ts` — Added `ausaExports` table; added `"MEMBER_EXPORTED"` to `ActivityActionType`
- `app/lib/activity.ts` — Added `membersExported` convenience method to `ActivityLogger`
- `app/members/actions.ts` — Added `exportMembersToCSV()` and `getAusaExportHistory()` server actions; added `escapeCsvField` helper
- `app/members/data-table.tsx` — Added `ExportRecord` type, export state, `useEffect` to load history, `handleExport` handler, Export button in toolbar, AUSA confirmation dialog with history list
- `drizzle/0017_tranquil_silvermane.sql` — Migration: creates `ausa_exports` table with FK to users

**Deviations from plan:**
- Used a plain `Button` (not `AlertDialogAction`) for the Download CSV button in the footer. This is intentional: `AlertDialogAction` auto-closes the dialog on click, but we want to keep it open while the export is in progress and close it only on success.
- Migration also captured some pre-existing untracked schema entries (`site_settings` columns, `activity_log` indexes) — these were already in `schema.ts` and are safe.

**Suggested next steps:**
- Run `npx drizzle-kit migrate` (or `drizzle-kit push` for dev) to apply the migration to your database
- Test the export flow end-to-end: click Export for AUSA → confirm dialog shows member count → download triggers → history updates
- Decide on the two open questions: Admin-only vs. exclude-Temporary access; optional export label field
